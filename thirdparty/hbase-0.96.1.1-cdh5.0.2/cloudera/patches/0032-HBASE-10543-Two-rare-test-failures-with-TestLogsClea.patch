From eaae2d07c90160d1f5508b4836ebbf8d5f5f63c8 Mon Sep 17 00:00:00 2001
From: Jimmy Xiang <jxiang@apache.org>
Date: Tue, 18 Feb 2014 19:28:42 +0000
Subject: [PATCH 32/73] HBASE-10543 Two rare test failures with TestLogsCleaner and TestSplitLogWorker

Reason: Test
Author: Jimmy Xiang
Ref: CDH-17394, CDH-17385

git-svn-id: https://svn.apache.org/repos/asf/hbase/branches/0.98@1569498 13f79535-47bb-0310-9956-ffa450edef68
---
 .../hbase/master/cleaner/TestLogsCleaner.java      |   13 +++++++++----
 .../hbase/regionserver/TestSplitLogWorker.java     |    2 +-
 2 files changed, 10 insertions(+), 5 deletions(-)

diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/master/cleaner/TestLogsCleaner.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/master/cleaner/TestLogsCleaner.java
index 353abbd..d203b58 100644
--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/master/cleaner/TestLogsCleaner.java
+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/master/cleaner/TestLogsCleaner.java
@@ -70,13 +70,12 @@ public class TestLogsCleaner {
     ReplicationQueues repQueues =
         ReplicationFactory.getReplicationQueues(server.getZooKeeper(), conf, server);
     repQueues.init(server.getServerName().toString());
-    Path oldLogDir = new Path(TEST_UTIL.getDataTestDir(),
+    final Path oldLogDir = new Path(TEST_UTIL.getDataTestDir(),
         HConstants.HREGION_OLDLOGDIR_NAME);
     String fakeMachineName =
       URLEncoder.encode(server.getServerName().toString(), "UTF8");
 
-    FileSystem fs = FileSystem.get(conf);
-    LogCleaner cleaner  = new LogCleaner(1000, server, conf, fs, oldLogDir);
+    final FileSystem fs = FileSystem.get(conf);
 
     // Create 2 invalid files, 1 "recent" file, 1 very new file and 30 old files
     long now = System.currentTimeMillis();
@@ -117,11 +116,17 @@ public class TestLogsCleaner {
 
     assertEquals(34, fs.listStatus(oldLogDir).length);
 
+    LogCleaner cleaner  = new LogCleaner(1000, server, conf, fs, oldLogDir);
     cleaner.chore();
 
     // We end up with the current log file, a newer one and the 3 old log
     // files which are scheduled for replication
-    assertEquals(5, fs.listStatus(oldLogDir).length);
+    TEST_UTIL.waitFor(1000, new Waiter.Predicate<Exception>() {
+      @Override
+      public boolean evaluate() throws Exception {
+        return 5 == fs.listStatus(oldLogDir).length;
+      }
+    });
 
     for (FileStatus file : fs.listStatus(oldLogDir)) {
       System.out.println("Kept log files: " + file.getPath().getName());
diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestSplitLogWorker.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestSplitLogWorker.java
index ef56d0c..950f785 100644
--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestSplitLogWorker.java
+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestSplitLogWorker.java
@@ -233,7 +233,7 @@ public class TestSplitLogWorker {
       byte [] bytes = ZKUtil.getData(zkw, PATH);
       SplitLogTask slt = SplitLogTask.parseFrom(bytes);
       assertTrue(slt.isOwned(SRV));
-      slt = new SplitLogTask.Unassigned(MANAGER);
+      slt = new SplitLogTask.Owned(MANAGER);
       ZKUtil.setData(zkw, PATH, slt.toByteArray());
       waitForCounter(SplitLogCounters.tot_wkr_preempt_task, 0, 1, 1500);
     } finally {
-- 
1.7.0.4

