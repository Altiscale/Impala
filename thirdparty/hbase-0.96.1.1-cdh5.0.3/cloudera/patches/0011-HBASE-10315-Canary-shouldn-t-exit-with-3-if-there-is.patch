From fe1246ff54c1ad7ae9a4a7205745d9dfb006c63d Mon Sep 17 00:00:00 2001
From: Elliott Neil Clark <eclark@apache.org>
Date: Mon, 13 Jan 2014 21:51:24 +0000
Subject: [PATCH 11/73] HBASE-10315 Canary shouldn't exit with 3 if there is no master running.

Reason: Bug
Author: Elliott Clark
Ref: CDH-16598

git-svn-id: https://svn.apache.org/repos/asf/hbase/branches/0.96@1557866 13f79535-47bb-0310-9956-ffa450edef68
---
 .../java/org/apache/hadoop/hbase/tool/Canary.java  |   15 +++++++++++++--
 1 files changed, 13 insertions(+), 2 deletions(-)

diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/tool/Canary.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/tool/Canary.java
index 21be8bf..47504d0 100644
--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/tool/Canary.java
+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/tool/Canary.java
@@ -243,14 +243,22 @@ public final class Canary implements Tool {
         // exit if any error occurs
         if (this.failOnError && monitor.hasError()) {
           monitorThread.interrupt();
-          System.exit(monitor.errorCode);
+          if (monitor.initialized) {
+            System.exit(monitor.errorCode);
+          } else {
+            System.exit(INIT_ERROR_EXIT_CODE);
+          }
         }
         currentTimeLength = System.currentTimeMillis() - startTime;
         if (currentTimeLength > this.timeout) {
           LOG.error("The monitor is running too long (" + currentTimeLength
               + ") after timeout limit:" + this.timeout
               + " will be killed itself !!");
-          monitor.errorCode = TIMEOUT_ERROR_EXIT_CODE;
+          if (monitor.initialized) {
+            System.exit(TIMEOUT_ERROR_EXIT_CODE);
+          } else {
+            System.exit(INIT_ERROR_EXIT_CODE);
+          }
           break;
         }
       }
@@ -320,6 +328,7 @@ public final class Canary implements Tool {
     protected HBaseAdmin admin;
     protected String[] targets;
     protected boolean useRegExp;
+    protected boolean initialized = false;
 
     protected boolean done = false;
     protected int errorCode = 0;
@@ -376,6 +385,7 @@ public final class Canary implements Tool {
         try {
           if (this.targets != null && this.targets.length > 0) {
             String[] tables = generateMonitorTables(this.targets);
+            this.initialized = true;
             for (String table : tables) {
               Canary.sniff(admin, sink, table);
             }
@@ -552,6 +562,7 @@ public final class Canary implements Tool {
     public void run() {
       if (this.initAdmin() && this.checkNoTableNames()) {
         Map<String, List<HRegionInfo>> rsAndRMap = this.filterRegionServerByName();
+        this.initialized = true;
         this.monitorRegionServers(rsAndRMap);
       }
       this.done = true;
-- 
1.7.0.4

