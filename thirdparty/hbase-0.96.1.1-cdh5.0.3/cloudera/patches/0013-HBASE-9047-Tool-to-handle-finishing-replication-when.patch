From 477089f32b56a83e29570d601de5a6e965347490 Mon Sep 17 00:00:00 2001
From: Lars Hofhansl <larsh@apache.org>
Date: Tue, 17 Dec 2013 05:42:05 +0000
Subject: [PATCH 13/73] HBASE-9047 Tool to handle finishing replication when the cluster is offline (Demai Ni)

Reason: New Feature
Author: Demai Ni
Ref: CDH-16915

git-svn-id: https://svn.apache.org/repos/asf/hbase/branches/0.96@1551462 13f79535-47bb-0310-9956-ffa450edef68
---
 .../regionserver/ReplicationSource.java            |   20 ++++++++++++++++++++
 .../regionserver/ReplicationSourceManager.java     |    8 ++++++++
 2 files changed, 28 insertions(+), 0 deletions(-)

diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java
index 5cebf8f..bea67f9 100644
--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java
+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java
@@ -498,6 +498,26 @@ public class ReplicationSource extends Thread
               }
             }
           }
+          // In the case of disaster/recovery, HMaster may be shutdown/crashed before flush data
+          // from .logs to .oldlogs. Loop into .logs folders and check whether a match exists
+          if (stopper instanceof ReplicationSyncUp.DummyServer) {
+            FileStatus[] rss = fs.listStatus(manager.getLogDir());
+            for (FileStatus rs : rss) {
+              Path p = rs.getPath();
+              FileStatus[] logs = fs.listStatus(p);
+              for (FileStatus log : logs) {
+                p = new Path(p, log.getPath().getName());
+                if (p.getName().equals(currentPath.getName())) {
+                  currentPath = p;
+                  LOG.info("Log " + this.currentPath + " exists under " + manager.getLogDir());
+                  // Open the log at the new location
+                  this.openReader(sleepMultiplier);
+                  return true;
+                }
+              }
+            }
+          }
+
           // TODO What happens if the log was missing from every single location?
           // Although we need to check a couple of times as the log could have
           // been moved by the master between the checks
diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceManager.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceManager.java
index 17d5463..b9ac55b 100644
--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceManager.java
+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceManager.java
@@ -285,6 +285,14 @@ public class ReplicationSourceManager implements ReplicationListener {
     return this.sources;
   }
 
+  /**
+   * Get a list of all the old sources of this rs
+   * @return list of all old sources
+   */
+  public List<ReplicationSourceInterface> getOldSources() {
+    return this.oldsources;
+  }
+
   void preLogRoll(Path newLog) throws IOException {
 
     synchronized (this.hlogsById) {
-- 
1.7.0.4

